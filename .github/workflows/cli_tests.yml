name: Test CLI

on:
  workflow_call:
    secrets:
      MORU_API_KEY:
        required: true
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  test:
    defaults:
      run:
        working-directory: ./packages/cli
        shell: bash
    name: CLI - Build (${{ matrix.os }})
    strategy:
      matrix:
        os: [ubuntu-22.04, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse .tool-versions
        uses: wistia/parse-tool-versions@v2.1.1
        with:
          filename: '.tool-versions'
          uppercase: 'true'
          prefix: 'tool_version_'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '${{ env.TOOL_VERSION_PNPM }}'

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '${{ env.TOOL_VERSION_NODEJS }}'
          registry-url: 'https://registry.npmjs.org'
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Configure pnpm
        run: |
          pnpm config set auto-install-peers true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build the SDK (pre-requisite for the tests)
        run: pnpm build
        working-directory: ./packages/js-sdk

      - name: Build the CLI
        run: pnpm build
        working-directory: ./packages/cli

      - name: Run tests
        run: pnpm test
        working-directory: ./packages/cli
        env:
          MORU_API_KEY: ${{ secrets.MORU_API_KEY }}

      - name: Setup bun (for binary compilation)
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Test binary compilation
        working-directory: ./packages/cli
        shell: bash
        env:
          VERSION: "test"
          BUN_TARGETS: ${{ runner.os == 'Linux' && 'linux-x64' || 'win-x64' }}
        run: bash ./scripts/build-binaries.sh

      - name: Test binary execution (e2e)
        working-directory: ./packages/cli
        shell: bash
        env:
          MORU_API_KEY: ${{ secrets.MORU_API_KEY }}
        run: |
          # Determine binary path (VERSION="test" creates "moru-vtest-{target}" files)
          if [ "${{ runner.os }}" = "Windows" ]; then
            BINARY="./dist/bin/moru-vtest-win-x64.exe"
          else
            BINARY="./dist/bin/moru-vtest-linux-x64"
            chmod +x "$BINARY"
          fi

          echo "Testing binary: $BINARY"

          # Test basic commands
          "$BINARY" --version
          "$BINARY" --help

          # Test actual sandbox creation (critical for catching Bun runtime issues)
          echo "Testing sandbox create command..."
          OUTPUT=$("$BINARY" sandbox create base --timeout 30 2>&1)
          echo "$OUTPUT"

          # Extract sandbox ID from output
          SANDBOX_ID=$(echo "$OUTPUT" | grep -oE 'i[a-z0-9]{23}' | head -1)

          if [ -z "$SANDBOX_ID" ]; then
            echo "Failed to create sandbox"
            exit 1
          fi

          echo "Successfully created sandbox: $SANDBOX_ID"

          # Clean up sandbox
          "$BINARY" sandbox kill "$SANDBOX_ID" || true
          echo "Binary e2e test completed successfully"
